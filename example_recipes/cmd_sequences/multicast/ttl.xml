<!-- Offline IP_MULTICAST_TTL test -->
<!-- Requires: 2 hosts
   -    [1] with one interface
   -    [2] with one interface
   - -->

<command_sequence>
    <!-- IP_MULTICAST_TTL sockopt conformance test -->
    <command type="test" value="Multicast" machine_id="1" timeout="30">
        <options>
            <option name="setup" value="sockopt_ttl" />
            <option name="condition" value="status == 'pass'" />
        </options>
    </command>

    <!-- IP_MULTICAST_TTL = 0, looped on one host -->
    <command type="exec" machine_id="1" value="sleep 1" />

    <command type="test" value="Multicast" machine_id="1" timeout="30" bg_id="1">
        <options>
            <option name="setup" value="send_simple" />
            <option name="address" value="{$multicast_group}" />
            <option name="port" value="{$port}" />
            <option name="duration" value="{$test_duration}" />
            <option name="delay" value="{$send_delay}" />
            <option name="ttl" value="0" />
            <option name="loop" value="1" />
            <option name="interface" value="{ip(1,1)}" />
        </options>
    </command>

    <command type="test" value="Multicast" machine_id="1" timeout="30">
        <options>
            <option name="setup" value="recv_simple" />
            <option name="address" value="{$multicast_group}" />
            <option name="port" value="{$port}" />
            <option name="duration" value="{$test_duration}" />
            <option name="interface" value="{ip(1,1)}" />

            <option name="condition" value="packets_received > 0" />
        </options>
    </command>

    <command type="wait" machine_id="1" value="1" />

    <!-- IP_MULTICAST_TTL = 0 between 2 hosts -->
    <!-- KNOWN BUG: according to the specs, packets
         with TTL=0 should not leave the host.

         Well it does, it's an intentional hack for some
         apps [1].

         http://www.spinics.net/lists/netdev/msg183704.html
      -->
    <command type="exec" machine_id="1" value="sleep 1" />
    <command type="exec" machine_id="2" value="sleep 1" />

    <command type="test" value="Multicast" machine_id="1" timeout="30" bg_id="1">
        <options>
            <option name="setup" value="send_simple" />
            <option name="address" value="{$multicast_group}" />
            <option name="port" value="{$port}" />
            <option name="duration" value="{$test_duration}" />
            <option name="delay" value="{$send_delay}" />
            <option name="ttl" value="0" />
            <option name="interface" value="{ip(1,1)}" />
        </options>
    </command>

    <command type="test" value="Multicast" machine_id="2" timeout="30">
        <options>
            <option name="setup" value="recv_simple" />
            <option name="address" value="{$multicast_group}" />
            <option name="port" value="{$port}" />
            <option name="duration" value="{$test_duration}" />
            <option name="interface" value="{ip(2,1)}" />

            <option name="condition" value="packets_received > 0" />
        </options>
    </command>

    <command type="wait" machine_id="1" value="1" />

    <!-- IP_MULTICAST_TTL = 1 between 2 hosts -->
    <command type="exec" machine_id="1" value="sleep 1" />

    <command type="test" value="Multicast" machine_id="1" timeout="30" bg_id="1">
        <options>
            <option name="setup" value="send_simple" />
            <option name="address" value="{$multicast_group}" />
            <option name="port" value="{$port}" />
            <option name="duration" value="{$test_duration}" />
            <option name="delay" value="{$send_delay}" />
            <option name="ttl" value="1" />
            <option name="interface" value="{ip(1,1)}" />
        </options>
    </command>

    <command type="test" value="Multicast" machine_id="2" timeout="30">
        <options>
            <option name="setup" value="recv_simple" />
            <option name="address" value="{$multicast_group}" />
            <option name="port" value="{$port}" />
            <option name="duration" value="{$test_duration}" />
            <option name="interface" value="{ip(2,1)}" />

            <option name="condition" value="packets_received > 0" />
        </options>
    </command>

    <command type="wait" machine_id="1" value="1" />
</command_sequence>
