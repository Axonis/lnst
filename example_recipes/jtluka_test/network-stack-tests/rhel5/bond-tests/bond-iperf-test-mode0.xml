<nettestrecipe>

    <machines>
        <machine id="1">
            <netmachineconfig source="../rhel58-guest1.xml"/>
            <netconfig>
                <netdevice id="1" phys_id="1" type="eth"/>
                <netdevice id="2" phys_id="2" type="eth"/>
                <netdevice id="3" type="bond">
                    <options>
                        <option name="mode" value="0" />
                        <option name="miimon" value="100" />
                    </options>
                    <slaves>
                        <slave id="1"/>
                        <slave id="2"/>
                    </slaves>
                    <addresses>
                        <address value="192.168.100.2/24" />
                    </addresses>
                </netdevice>
            </netconfig>
        </machine>

        <machine id="2">
            <netmachineconfig source="../rhel58-guest2.xml"/>
            <netconfig>
                <netdevice id="1" phys_id="1" type="eth"/>
                <netdevice id="2" phys_id="2" type="eth"/>
                <netdevice id="3" type="bond">
                    <options>
                        <option name="mode" value="0" />
                        <option name="miimon" value="100" />
                    </options>
                    <slaves>
                        <slave id="1"/>
                        <slave id="2"/>
                    </slaves>
                    <addresses>
                        <address value="192.168.100.3/24" />
                    </addresses>
                </netdevice>
            </netconfig>
        </machine>
    </machines>


    <command_sequence>

<!-- just a ping check ... -->

        <command machine_id="1" type="test" value="IcmpPing">
            <options>
                <option type="recipe_eval" name="addr" value="['machines'][2]['netconfig'][3]['addresses'][0]" />
                <option name="count" value="3"/>
            </options>
        </command>

<!-- start iperf tests ... -->

        <command machine_id="2" type="test" value="Iperf" bg_id="1">
            <options>
                <option name="role" value="server" />
                <option name="install_dir" value="/root" />
                <option name="bind" type="recipe_eval" value="['machines'][2]['netconfig'][3]['addresses'][0]" />
            </options>
        </command>

        <command type="exec" value="sleep 3" />

        <command machine_id="1" type="test" value="Iperf">
            <options>
                <option name="role" value="client" />
                <option name="duration" value="600"/>
                <option name="install_dir" value="/root" />
                <option name="iperf_server" type="recipe_eval" value="['machines'][2]['netconfig'][3]['addresses'][0]" />
            </options>
        </command>

        <command type="kill" machine_id="2" value="1" />

    </command_sequence>

</nettestrecipe>
